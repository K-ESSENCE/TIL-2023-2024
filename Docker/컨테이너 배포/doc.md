### AWS ECS

AWS ECS 는 4가지 범주로 생각함

클러스터: 서비스가 실행되는 전체 네트워크

컨테이너
태스크 : 앱의 블루프린트임 AWS에 컨테이너를 시작하는 방법을 알린다 / docker run 이 아니라 실행하는 서버를 구성하는 방법 태스크에는 한개이상의 컨테이너가 있을 수 있음

나중에 하나의 동일한 태스크에 여러 컨테이너를 추가할 때 이를 볼 수 도 있을 것임

하나의 리모트 머신을 태스크 라고 할 수 있음

FARGATE : 서버리스 모드에서 작동 => 비효율적으로 효율적 서버리스가 그렇지 뭐

로드밸런서 추가해서 수신 요청 리디렉션/ 대기열 쌓기/ 컨테이너 실행 등 백그라운드에서 모든걸 관리

강의에서는 TASK ID 누르면 public ip가 보임

서비스 => 태스크를 기반으로 함 태스크를 먼저 생성 ㄱ

FARGAE? => 필요할때만 컨테이너가 실행되는 서버를 만들고 그 환경에서 컨테이너를 실행한다는것을 의미함

필요할때만 서버를 구동해서 EC2인스턴스를 항상 가지고 있지 않다는것을 의미함

이건 그냥 서버리스 특징인디

### 관리되는 컨테이너 업데이트하기

이미지 업데이트해서 도커허브에 푸쉬하고 그다음 어떻게 업데이트하냐? 이 문제에대한 부분

클러스터 -> default -> tasks ->task definition -> create new revision
같은 task를 다시 만들면 aws는 최신 이미지를 사용함

그리고 Update service 혹은 Force new Deplopyment

하면 PUBLIC ip가 변경됨 구동되는 모든 개정판에 새로운 ip할당

### 다중 컨테이너 앱 준비

도커 컴포즈는 로컬에서 다중돌리기에는 훌룡하지만 배포에 좋은 도구는 아님

그래서 배포에 도커 컴포즈를 사용하지는 않을것임

뭔가를 배포해서 리모트 머신으로 이동시키면 상황이 더 복잡해짐 ->CPU 용량을 정의등 해야될게많아짐

도커 컴포즈의 각각의 이미지를 만들고 push를 할것임

불행히도 ecs는 컨테이너 IP를 자동으로 찾는 기능을 사용하지못함 => 로컬과 다르게 컨테이너가 항상 동일 머신에서 실행될 가능성이 거의 없다

(컨테이너이름 끼리 네트워크 매칭시키는거 말하는것)

ECS 로 배포하고자 할때 localhost주소를 사용하게끔 함

아니면 환경변수를 넣어서 동일 구성으로 만들수도있음

커맨드에 node,app.js 쉼표로 구분된 명령

동일테스크에 컨테이너 추가하면 localhost 키 하에서 서로 통신가능

value를 localhost를 사용해서 동일한 태스크의 일부가 되는 다른 컨테이너에 요청가능

여기선 MONGODB_URL 의 값을 localhost로 맵핑

### 안정적인 도메인을 위한 로드밸런서

배포될떄마다 변경되는 IP를 위해 로드밸런서 사용

ECS Service로 가면 태스크가 항상 중지되고 재시작 되는데 그게 로드밸런서에 의해 수행됨

로드밸런서는 요청을 리디렉션하는 서비스의 상태를 확인하고 비정상임을 발견하면 껏다키기 떄문

ec2-> target groups -> edit health check setting

로드 밸런서는 디폴트로 배포된 서비스 '/'로 요청을 보냄 => 비정상으로보고 404 처리

요청이 성공 코드로 응답할 엔드포인트로 변경 필요

로드 밸런서 보안 그룹 디폴트외에 새로운 보안그룹 추가 필요
